<!doctype html>

<link rel="stylesheet" href="../../modalities/dom/components/icons.css">

<style>
  body {
    font-family: sans-serif;
  }
  icon {
    /* margin: 0 4px; */
  }
  [row] {
    display: flex;
    align-items: center;
  }
  [children] {
    margin-left: 24px;
  }
  [delete] {
    margin-left: 8px;
    visibility: hidden;
  }
  [entry] {
    padding: 2px 8px;
    border-radius: 8px;
  }
  [entry]:hover {
    background-color: #edeecd;
  }
  [entry]:hover [delete] {
    visibility: visible;
  }
</style>

<script type="module">
  import '../lib/build/firebase.js';
  import {database} from '../lib/firebase.js'
  import {Xen} from '../lib/xen.js'
  //
  const itemTemplate = Xen.Template.html`
    <div>
      <div row key="{{key}}" on-click="onClick">
        <icon>{{icon}}</icon>
        <div entry row>
          <span>{{title}}</span>
          <icon delete>delete_forever</icon>
        </div>
      </div>
      <div children></div>
    </div>
  `;
  //
  const snarfAll = async () => {
    const ref = database.ref('0_6_0');
    console.log('querying database...');
    ref.once('value', snap => {
      console.log('evaluating snapshot...');
      const corpus = snap.val();
      const prefixi = {};
      Object.keys(corpus).forEach(key => {
        const prefix = key.split('-').shift();
        const group = prefixi[prefix] || (prefixi[prefix] = {$title: `${key} (group)`});
        group[key] = corpus[key];
      });
      console.log('dumping keys...');
      renderChildren(prefixi, document.body);
    });
    //
    const renderChildren = (group, container) => {
      Object.keys(group || Object).filter(key => key[0] !== '$').forEach(key => {
        const item = group[key];
        const isGroup = typeof item === 'object';
        let title = isGroup && item.$title || key;
        if (isGroup) {
          const count = isGroup && Object.keys(item).length;
          if (count) {
            title = `${title} (${count} items)`;
          }
        }
        const icon = isGroup ? 'arrow_right' : '';
        const dom = Xen.Template.stamp(itemTemplate).appendTo(container).set({key, title, isGroup, icon}).events({
          onClick: event => {
            event.stopPropagation();
            if (isGroup) {
              const icon = item.$open ? 'arrow_right' : 'arrow_drop_down';
              item.$dom.set({icon});
              const container = item.$dom.firstElement.querySelector('[children]');
              if (item.$open) {
                container.innerText = '';
              } else {
                renderChildren(item, container);
              }
              item.$open = !item.$open;
            }
          }
        });
        if (isGroup) {
          item.$dom = dom;
        }
      });
    }
  }
  snarfAll();
</script>
