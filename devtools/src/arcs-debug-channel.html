<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="arcs-debug-channel">
  <template>
    <style>
      :host {
        display: block;
        padding: 10px;
        border-top: 1px solid #888;
      }
      #connectionIndicator {
        width: 10px;
        height: 10px;
        border-radius: 5px;
        display: inline-block;
        box-shadow: -1px -1px 2px 1px rgba(0,0,0,.25) inset, 0 0 1px black;
        margin-right: 5px;
        background-color: #ffff00;
      }
      #connectionIndicator[connected='true'] {
        background-color: #00ff00;
      }
      #connectionIndicator[connected='false'] {
        background-color: #ff0000;
      }
    </style>
    <span id="connectionIndicator"></span>
    <span id="connectionLabel"></span>
  </template>

  <script>
    class ArcsDebugChannel extends Polymer.Element {
      static get is() { return 'arcs-debug-channel'; }

      ready() {
        super.ready();
        if (chrome.devtools && chrome.devtools.inspectedWindow.tabId) {
          this._connectViaExtensionApi();
        } else {
          this._connectViaWebSocket();
        }
      }

      // TODO: Move connection + message receiving logic into devtools.js,
      //       so that we can start listening before Arcs panel is clicked.
      _connectViaExtensionApi() {
        this._updateUi('Inspected Tab', true);

        let backgroundPageConnection = chrome.runtime.connect({name: 'arcs'});
        backgroundPageConnection.postMessage({
            name: 'init',
            tabId: chrome.devtools.inspectedWindow.tabId
        });
        backgroundPageConnection.onMessage.addListener(
          e => this._surfaceIncomingMessages(e));
      }

      _connectViaWebSocket() {
        this._updateUi('Connecting to Node JS');

        let ws = new WebSocket('ws://localhost:8787');
        ws.onerror = e => this._updateUi('Disconnected', false);
        ws.onclose = e => this._updateUi('Disconnected', false);
        ws.onopen = e => {
          this._updateUi('Node JS', true);
          ws.onmessage = msg => this._surfaceIncomingMessages(JSON.parse(msg.data));
          ws.send("init");
        };
      }

      _updateUi(label, connected) {
        this.$.connectionLabel.innerText = label;
        if (connected === undefined) {
          this.$.connectionIndicator.removeAttribute('connected');
        } else {
          this.$.connectionIndicator.setAttribute('connected', connected);
        }
      }

      _surfaceIncomingMessages(e) {
        this.dispatchEvent(new CustomEvent('messages', {detail: e}));
      }
    }

    window.customElements.define(ArcsDebugChannel.is, ArcsDebugChannel);
  </script>
</dom-module>
