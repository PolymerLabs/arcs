version: '0.0.{build}'

environment:
  nodejs_version: '10'

init:
  - cmd: set NODE_OPTIONS=--max-old-space-size=1024

image:
  - Visual Studio 2013
  - Visual Studio 2015

install:
  - ps: Install-Product node $env:nodejs_version x64
  - choco install -y python2 gtk-runtime libjpeg-turbo
  # Sets Windows 7.1 SDK env vars.
  - '"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.cmd" /x64'
  # Prepend 2015 and 2013 tools. Harmless when the path for the other version doesn't exist.
  - set "PATH=%ProgramFiles(x86)%\MSBuild\14.0\Bin;%ProgramFiles(x86)%\MSBuild\12.0\Bin;%PATH%"
  - # Put GTK in C:/ @see https://github.com/Automattic/node-canvas/blob/master/appveyor.yml
  - curl -fLsS -o "gtk.zip" "http://ftp.gnome.org/pub/GNOME/binaries/win64/gtk+/2.22/gtk+-bundle_2.22.1-20101229_win64.zip"
  - 7z x gtk.zip -oGTK > nul
  - mv GTK/ C:/
  - curl -fLsS -o "libjpeg.exe" "https://downloads.sourceforge.net/project/libjpeg-turbo/1.5.2/libjpeg-turbo-1.5.2-vc64.exe"
  - .\libjpeg.exe /S
  - npm install -g npm@6.9.0
  - appveyor-retry npm install

build: off

# Instead of specific targets, this should use `npm test`.
# But, that needs some work, and the tests themselves aren't stable so I'm
# going to wait to add more sources of possible failure.
test_script:
  - node --version
  - npm --version
  - npm run test-no-web
