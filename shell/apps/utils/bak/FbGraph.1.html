<!--
<cloud-users></cloud-users>
<hr>
<pre id="users"></pre>
<hr>
<h3>Scott</h3>
<pre id="arcs"></pre>
-->

<button onclick="testFieldValue()">Test Field Value</button>

<pre id="outpre"></pre>

<script type="module">
  import {FieldFactory} from './FBGraph.js';

  const scott = `-LBXevFOcUyM-TvYr5oq`;
  const somebody = `-L-8Hr1jivDeJid-oZbx`;
  const userid = scott;

  const profile = {};
  const user = {
    friends: {}
  };
  const boxes = {};

  const go = () => {
    const handler = (field, {type, detail, sender}) => {
      console.log(`WATCH: [${field}] [${type}]:`, detail, sender);
      if (detail.data) {
        if (!profile[field]) {
          profile[field] = [];
        }
        profile[field].push(detail.data);
        const ph = profileHandlers[field];
        ph && ph({type, detail, sender});
      }
      window.outpre.innerHTML = JSON.stringify(Object.keys(profile), null, '  ');
      //console.log('PROFILE:', profile);
    };

    const profileHandlers = {
      friends: ({type, detail, sender}) => {
        const friends = user.friends
        // grab up ids
        const ids = {};
        Object.values(detail.data).forEach(entity => ids[entity.rawData.id] = 1);
        // add friends
        Object.keys(ids).forEach(id => {
          if (!friends[id]) {
            console.log(`[${id}] is now a friend`);
            friends[id] = FieldFactory('users', id, userSchema, friendHandler);
          }
        })
      }
    };

    const friendHandler = () => {
      if (detail.data) {
        if (!profile[field]) {
          profile[field] = [];
        }
        profile[field].push(detail.data);
        const ph = profileHandlers[field];
        ph && ph({type, detail, sender});
      }
      window.outpre.innerHTML = JSON.stringify(Object.keys(profile), null, '  ');
    };

    const userSchema = {
      arcs: [{
        $key: {
          join: `/arcs`,
          schema: {
            shim_handles: [handler],
            steps: true
          }
        },
        $fields: true
      }],
      info: true
    };

    const friendSchema = {
      arcs: [{
        $key: {
          join: `/arcs`
        },
        $fields: true
      }],
      info: true
    };

    const arcs = {
      users: [user]
    };

    return FieldFactory(`users`, userid, userSchema);
  };

  const field = go();

  window.field = field;
  window.profile = profile;
  window.user = user;

  window.testFieldValue = () => {
    console.clear();
    console.log(`> field.value()`);
    console.log(field.value());
  };
</script>

