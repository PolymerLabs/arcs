<cloud-users></cloud-users>
<hr>
<pre id="users"></pre>
<hr>
<h3>Scott</h3>
<pre id="arcs"></pre>

<script type="module">
  //
  import Xen from '../../components/xen/xen.js';
  import Firebase from '../common/firebase-config.js';
  //
  const Eventer = class {
    constructor(cb) {
      this.cb = cb;
    }
    _fire(type, detail) {
      if (this.cb) {
        this.cb({type, detail});
      }
    }
  }
  //
  const DbValue = class extends Eventer {
    constructor(path, cb) {
      super(cb);
      this._attach(Firebase.db.child(path));
    }
    _attach(db) {
      let started;
      const value = db.on('value', snap => {
        this.initialized = true;
        this.value = snap.val();
        this._fire('changed', snap.key)
      });
      this._detach = () => {
        node.off('value', value);
      }
    }
  }
  //
  const DbSet = class extends Eventer {
    constructor(path, cb) {
      super(cb);
      this.set = {};
      this._attach(Firebase.db.child(path));
    }
    _attach(db) {
      let started;
      const added = db.on('child_added', (snap, prevKey) => {
        if (!this.set[snap.key]) {
          this.set[snap.key] = snap.val();
        }
        this._fire('added', snap.key)
      });
      const changed = db.on('child_changed', (snap, prevKey) => {
        this.set[snap.key] = snap.val();
        console.log('changed', snap.key);
        this._fire('changed', snap.key)
      });
      const removed = db.on('child_removed', snap => {
        this.set[snap.key] = null;
        console.log('removed', snap.key);
        this._fire('removed', snap.key)
      });
      this._detach = () => {
        node.off('child_added', added);
        node.off('child_changed', changed);
        node.off('child_removed', removed);
      }
      db.once('value', snap => {
        this.initialized = true;
        this.set = snap.val();
        this._fire('initial', this.set);
      });
    }
  }
  //
  const DbArc = class extends Eventer {
    constructor(arcid, cb) {
      super(cb);
      this._arcid = arcid;
      this._dbmeta = new DbValue(`arcs/${arcid}/metadata`, event => this.metaHandler(event));
      //this._dbmeta = new DbValue(`arcs/${arcid}/metadata`, event => this.metaHandler(event));
    }
    get meta() {
      return this._dbmeta.value;
    }
    metaHandler({type, detail}) {
      const meta = this.meta;
      if (meta.share > 0) {
        console.log(`[${this.arcid}] has shared data`, meta);
        this._db
      }
      break;

      this._fire('meta', meta);
    }
  }
  //
  const DbUsers = class extends Eventer {
    constructor(cb) {
      super(cb);
      this._dbset = new DbSet('users', event => this.handler(event));
    }
    get users() {
      return this._dbset.set;
    }
    handler({type, detail}) {
      switch (type) {
        case 'added':
          console.log('user', detail, this.users[detail]);
          if (this._dbset.initialized) {
            this._fire(type, detail);
          }
          return;
      }
      this._fire(type, detail);
    }
  }
  //
  const DbUser = class extends Eventer {
    constructor(dbusers, userid, cb) {
      super(cb);
      this._dbusers = dbusers;
      this._userid = userid;
      this._dbArcs = {};
      this._dbUserArcs = new DbSet(`users/${userid}/arcs`, event => this._arcsHandler(event));
    }
    get name() {
      try {
        return this._dbusers.users[this._userid].info.name;
      } catch(x) {
        return '(no name)';
      }
    }
    get arc() {
      return this._dbarcs.value;
    }
    _arcsHandler({type, detail}) {
      const dbArcs = this._dbArcs;
      switch (type) {
        case 'added':
          console.log(`${this.name} owns arc`, detail);
          this._addArc(dbArcs, detail);
          return;
        case 'removed':
          console.log(`${this.name} lost arc`, detail);
          this._removeArc(dbArcs, detail);
          return;
        case 'init':
          console.log(`got initial set of ${this.name}'s arcs`);
          break;
      }
      //this._fire(type, detail);
    }
    _addArc(dbarcs, arcid) {
      const name = this.name;
      if (!dbarcs[arcid]) {
        dbarcs[arcid] = new DbArc(arcid, ({type, detail}) => {
          switch (type) {
            case 'meta':
              if (detail.share > 0) {
                console.log(`${this.name}'s arc [${arcid}] has shared data`, detail);
              }
              break;
          }
        });
      }
    }
    _removeArc(dbarcs, arcid) {
      const dbarc = dbarcs[arcid];
      if (dbarc) {
        dbarc.dipose();
        dbarcs[arcid] = null;
      }
    }
  }
  //
  const scottid = `-LBXevFOcUyM-TvYr5oq`;
  //
  const go = () => {
    const dbUsers = new DbUsers(({type, detail}) => {
      switch (type) {
        case 'initial':
          const user = new DbUser(dbUsers, scottid);
          break;
      }
    });
  };
  //
  go();
</script>
