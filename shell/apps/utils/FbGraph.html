<!doctype html>
<meta charset="utf-8">

<style>
  body, button {
    font-family: sans-serif;
    font-size: 10px;
  }
  a {
    text-decoration: none;
    color: inherit;
  }
  pre {
    line-height: 150%;
    font-family: sans-serif;
  }
  .disclosure {
  }
  table {
    width: 240px;
    flex-shrink: 0;
    border-collapse: collapse;
    margin-right: 16px;
  }
  #avatarsTable {
    width: 200px;
  }
  th {
    background-color: #eeeeee;
  }
  td, th {
    padding: 4px 6px;
    border: 1px solid #bbbbbb;
    margin: 0;
  }
  [mono] {
    font-family: Consolas, monospace;
  }
</style>

<div style="display: flex;">
  <table id="usersTable">
    <tr>
      <th colspan="2">Users</th>
    </tr>
    <tr>
      <th>ID</th><th>Name</th>
    </tr>
  </table>

  <table id="avatarsTable">
    <tr>
      <th colspan="1">Avatars</th>
    </tr>
    <tr>
      <th>URL</th>
    </tr>
  </table>

  <table id="friendsTable">
    <tr>
      <th colspan="2">Friends</th>
    </tr>
    <tr>
      <th>ID</th><th>Name</th>
    </tr>
  </table>

  <div style="min-width:400px;">
    <button onclick="testUsersValue()">Test Users Value</button>
    <button onclick="testUserValue()">Test User Value</button>
    <button onclick="testProfileValue()">Test Profile Value</button>
    <pre id="outpre"></pre>
    <div id="outdiv"></div>
  </div>
</div>

<fb-users></fb-users>
<fb-user></fb-user>

<script src="../../components/renderjson.js"></script>

<script type="module">
  import {DbField} from './FbGraph.js';
  import {FbUsers} from './FbUsers.js';
  import {FbUser} from './FbUser.js';
  import Xen from '../../components/xen/xen.js';

  renderjson.set_icons(' ▶ ', ' ▼ ');
  renderjson.set_show_to_level(2)

  const renderValue = (value, level) => {
    renderjson.set_show_to_level(level || 1)
    outdiv.textContent = '';
    outdiv.appendChild(renderjson(value));
  };

  // users

  const users = document.querySelector('fb-users');
  users.addEventListener('changed', ({detail}) => onUserChanged(detail));
  users.addEventListener('removed', ({detail}) => onUserRemoved(detail));

  const onUserRemoved = field => {
    const node = window.usersTable.querySelector(`[id="${field.key}"]`);
    node && node.remove();
  };

  const onUserChanged = field => {
    onUserRemoved(field.key);
    const user = field.value;
    const name = user.info && user.info.name || '(Anonymous)';
    const node = window.usersTable.appendChild(
      Object.assign(document.createElement('tr'), {
        onclick: e => selectUser(e.currentTarget, field.key),
        innerHTML: `<td mono>${field.key}</td><td>${name}</id>`
      })
    );
    node.setAttribute('id', field.key);
  };

  // user

  const user = document.querySelector('fb-user');
  user.addEventListener('profile-changed', ({detail}) => onProfileChanged(detail));
  user.addEventListener('friend-changed', ({detail}) => onFriendChanged(detail));

  let userProfile;

  const selectUser = (node, detail) => {
    //console.log('selected', detail);
    if (selectUser.lastNode) {
      selectUser.lastNode.style.backgroundColor = '';
    }
    selectUser.lastNode = node;
    selectUser.userid = detail;
    node.style.backgroundColor = '#b3e5fc';
    //
    [...friendsTable.querySelectorAll('tr')].slice(2).forEach(tr => tr.remove());
    [...avatarsTable.querySelectorAll('tr')].slice(2).forEach(tr => tr.remove());
    //
    userProfile = Object.create(null);
    user.userid = detail;
    //user = window.user = getUser(detail);
    //user.activate();
  };

  const removeAvatar = arcid => {
    const node = window.avatarsTable.querySelector(`[id=${arcid}]`);
    node && node.remove();
  }

  // const removeProfileData = (sender, detail) => {
  //   const arcid = sender.path.split('/').slice(2).shift();
  //   const profile = userProfile[field];
  //   delete profile[arcid];
  //   if (detail === 'avatar') {
  //     removeAvatar(arcid);
  //   }
  // };

  const onProfileChanged = ({path, key, value}) => {
    //console.log(path, key, value);
    const arcid = path.split('/').slice(2).shift();
    const profile = userProfile[key] || (userProfile[key] = Object.create(null));
    profile[arcid] = value;
    if (key === 'avatar') {
      removeAvatar(arcid);
      const url = value.data.rawData.url.replace(`https://$cdn/`, `../../`).replace(`https://$shell/`, `../../`);
      const node = window.avatarsTable.appendChild(
        Object.assign(document.createElement('tr'), {
          innerHTML: `<td><img src="${url}"></td>`
        })
      );
      node.setAttribute('id', arcid);
    }
  };

  const onFriendChanged = ({path, key, value, fields}) => {
    let user, userid;
    try {
      // TODO(sjmiles): field name `id` is the join point to `users` subtree, so the actual data here is
      // `id: users[id]` ... this means we've hidden the actual 'id' value
      user = value.rawData.id;
      // TODO(sjmiles): must be a better way
      userid = fields.rawData.data.id;
    } catch(x) {
      console.warn(`added friend had incomplete join`);
      return;
    }
    //
    const old = window.friendsTable.querySelector(`[id="${key}"]`);
    old && old.remove();
    //
    const name = user.info && user.info.name || '(Anonymous)';
    const node = window.friendsTable.appendChild(
      Object.assign(document.createElement('tr'), {
        onclick: e => selectUser(e.currentTarget, key),
        innerHTML: `<td mono>${userid}</td><td>${name}</id>`
      })
    );
    node.setAttribute('id', key);
  }

  // const profileHandleChanged = (sender, {type, detail}) => {
  //   switch (type) {
  //     case 'changed':
  //       addProfileData(sender, detail);
  //       break;
  //     case 'removed':
  //       break;
  //   }
  // };

  // const arcsHandlesSchema = {
  //   '*': {
  //     '$key': (parent, field, datum) => ({
  //       $join: {
  //         path: `/arcs/${parent}`
  //       }
  //     })
  //   }
  // };

  // const friendChanged = ({key, value, fields}) => {
  //   //switch (type) {
  //     //case 'changed':
  //       let user, userid;
  //       try {
  //         // TODO(sjmiles): field name `id` is the join point to `users` subtree, so the actual data here is
  //         // `id: users[id]` ... this means we've hidden the actual 'id' value
  //         user = value.rawData.id;
  //         // TODO(sjmiles): must be a better way
  //         userid = fields.rawData.data.id;
  //       } catch(x) {
  //         console.warn(`added friend had incomplete join`);
  //         return;
  //       }
  //       //
  //       const old = window.friendsTable.querySelector(`[id="${key}"]`);
  //       old && old.remove();
  //       //
  //       const name = user.info && user.info.name || '(Anonymous)';
  //       const node = window.friendsTable.appendChild(
  //         Object.assign(document.createElement('tr'), {
  //           onclick: e => selectUser(e.currentTarget, key),
  //           innerHTML: `<td mono>${userid}</td><td>${name}</id>`
  //         })
  //       );
  //       node.setAttribute('id', key);
  //     //  break;
  //     //case 'removed':
  //     //  window.friendsTable.querySelector(`[id="${key}"]`).remove();
  //     //  break;
  //   //}
  // };

  // const friendSchema = {
  //   data: {
  //     '*': {
  //       $changed: friendChanged,
  //       rawData: {
  //         id: (parent, field, datum) => {
  //           return {
  //             $join: {
  //               path: `/users/${datum}`,
  //               schema: {
  //                 arcs: arcsHandlesSchema
  //               }
  //             }
  //           };
  //         }
  //       }
  //     }
  //   }
  // };

  // const userProfileArcReferenceSchema = {
  //   '$key': (parent, field, datum) => ({
  //     $join: {
  //       path: `/arcs/${parent}`,
  //       schema: {
  //         'shim_handles': {
  //           //$changed: profileHandleChanged,
  //           '*': (parent, field, datum) => {
  //             const schema = {
  //               $changed: profileHandleChanged
  //             };
  //             switch (field) {
  //               case 'friends':
  //                 return Object.assign(schema, friendSchema);
  //             }
  //             return schema;
  //           }
  //         }
  //       }
  //     }
  //   })
  // };

  // const userSchema = {
  //   info: true,
  //   arcs: {
  //     '*': userProfileArcReferenceSchema
  //   }
  // };

  // const getUser = userid => {
  //   [...friendsTable.querySelectorAll('tr')].slice(2).forEach(tr => tr.remove());
  //   [...avatarsTable.querySelectorAll('tr')].slice(2).forEach(tr => tr.remove());

  //   user = document.querySelector('fb-users');
  //   user.addEventListener('changed', ({detail}) => addProfileData(detail));
  //   user.userid = userid;
  //   //user.addEventListener('remove', ({detail}) => removeUser(detail));
  //   return user;

  //   // userProfile = Object.create(null);
  //   // return new DbField(null, `/users/${userid}`, userid, userSchema);
  // };

  window.user = user;
  window.users = users;

  window.testUsersValue = () => {
    renderValue(users.value);
  }
  window.testUserValue = () => {
    renderValue(user.value, 2);
  }
  window.testProfileValue = () => {
    renderValue(userProfile, 2);
  }
</script>
