<!doctype html>
<meta charset="utf-8">

<style>
  a {
    text-decoration: none;
    color: inherit;
  }
  pre {
    line-height: 150%;
    font-family: sans-serif;
    font-size: 0.75em;
  }
  .disclosure {
    font-size: 0.75em;
  }
</style>

<button onclick="testFieldValue()">Test Field Value</button>
<!-- <button onclick="testUserValue()">Test User Value</button> -->
<!-- <button onclick="testProfileValue()">Test Profile Value</button> -->

<pre id="outpre"></pre>
<div id="outdiv"></div>

<script src="../../components/renderjson.js"></script>

<script type="module">
  import {Eventer, DbSet} from './DbUtils.js';

  //const field = new DbSet('/users/-L-3KjicNMIVp30vIegB/arcs/-LFeAiiJvtPYdQFsKVwt/touched',
  //  event => console.log(event.type, event.detail));

  const Field = class extends Eventer {
    constructor(data, path, schema, onevent) {
      super(onevent);
      this.schema = schema;
      this.fields = {};
      this.data = data;
      if (data) {
        Object.keys(data).forEach(key => this.fieldChanged(key));
      }
    }
    fieldChanged(field) {
      const fieldSchema = this.schema['*'] || this.schema[field];
      if (fieldSchema) {
        console.log('field: creating field for', field);
        this.fields[field] = new Field(this.data[field], field, fieldSchema);
      }
    }
    getValue() {
      return this.data;
    }
  };

  const DbField = class extends Field {
    constructor(path, schema, onevent) {
      super(null, path, schema, onevent);
      this.dbset = new DbSet(path, event => this._onEvent(event));
      this.data = this.dbset.set;
    }
    _onEvent({type, detail}) {
      if (type === 'added') {
        if (this.schema) {
          const fieldSchema = this.schema['*'] || this.schema[detail];
          if (fieldSchema) {
            console.log('dbfield: creating field for', detail, fieldSchema);
            this.fields[detail] = new Field(this.data[detail], detail, fieldSchema);
          }
        }
      }
      //this._fire(type, detail);
    }
    getValue() {
      const results = {};
      Object.keys(this.data).forEach(key => {
        const field = this.fields[key];
        results[key] = field ? field.data : data[key];
      });
      return results;
    }
  };

  const field = new DbField('/users', {
    '*': {
      arcs: {
        '*': (parent, field) => {
          return {
            $join : `/arcs/${parent}`
          };
          // console.log(parent, field);
          // new Field(`/arcs/${parent}`, null, event => {
          //   if (event.type === 'initial') {
          //     console.warn(event);
          //   }
          // });
        }
      }
    }
  });
  window.field = field;

  // const field = new DbSet('/users', event => {
  //   if (event.type === 'added') {
  //     const user = field.set[event.detail];
  //     if (user.arcs) {
  //       const arcKey = Object.keys(user.arcs)[0];
  //       const arc = user.arcs[arcKey];
  //       //console.log(user, arc);
  //       const arcSet = new DbSet(`/arcs/${arcKey}`, function(event) {
  //         if (event.type === 'initial') {
  //           console.log(user, arcKey, event.detail)
  //         };
  //       });
  //     }
  //   }
  // });

  renderjson.set_icons(' ▶ ', ' ▼ ');
  renderjson.set_show_to_level(2)

  const renderValue = (value, level) => {
    renderjson.set_show_to_level(level || 1)
    outdiv.textContent = '';
    outdiv.appendChild(renderjson(value));
  };

  window.testFieldValue = () => {
    renderValue(field.getValue());
  }
</script>