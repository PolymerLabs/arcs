language: node_js
node_js:
  - "10"
env:
  global:
    # an encrypted 'GITHUB_TOKEN=<token>' for the PolymerLabs/arcs repo
    secure: "XAicBDiWddf8/mIxkEtr4xq6ihF0Bg+2eXi1goyQB+TU/EW3XoApryJGQzbMViRu35YHPWTJPA05kiSeGLHjsbXfbhrHt8aaw+cBTpY1KgD462nq8sqB8lf/nYcG8RpdvzIssEWlouvT3lxauTmxiNC9cSLgNcO991TdGsx+EqQyjmGXBDkFzhCUi95YfXdnTpcc69KBw0CFpTKalTJudlwnEB9nwdnrSko1oGxE1ZkAKayhvF/3VrRSEGqQ16ZWRI77tNo1uuACEiiyF+jVjk7hAILOzU7SJlnb4aexiYrenvSEH1jaTycz2RFfrykme8SQq9kb19PbkFkCMFYbRYJugMmRc0l69d1iz/ZL7yWoxhbX+35hBPGKhcdwaQ2VhEKYbmP4+DWK1K766zlr+FZsY2a8h5X0S5vcJAtWnOrZYfmksXGICImQcvMiFQ4asoJY93LVXrcNTaC/XAMIQ7lgUv1bak87LeA8O+UCuD8e/nju6fFhOKw/rHNBWBCZJpSV5im02DHfH2XDvkE//4/Ghp9DaIGODmXqClBi8y+IwQ0PwARHcnzELXQYAlG1ShE1iEV5TzmFiIOUtAqfr2sYBzEzy3J7NZADveqplONtKhNo9dnDmRcGLKGx+EL7E/e3SIvHRJY9+Md/31Dnw54ei6CSwx/zei+Tv2/V+bQ="

# todo: remove this once travis fixes their upstream issue (travis-ci/travis-ci#8836)
sudo: required
addons:
  chrome: stable

script:
  - npm run test-with-start
  - npm run build:rollup
  - npm --prefix=server test
  - npm run test-health

before_install:
  - npm install -g npm@6.9.0
  - node --version
  - npm --version

cache: npm

install:
  - npm ci
  - npm --prefix=server ci

before_deploy:
  # build apidocs
  - cd ${TRAVIS_BUILD_DIR} && npm run build:typedoc
  # Travis pages deploys skips artifacts from .gitignore. We need some of those, so
  # remove them from .gitignore.
  - cd ${TRAVIS_BUILD_DIR} && sed -i.sedbackup -e '/^shells\/env\/build$/d' .gitignore
  - cd ${TRAVIS_BUILD_DIR} && sed -i.sedbackup -e '/^build$/d' .gitignore
  - cd ${TRAVIS_BUILD_DIR} && sed -i.sedbackup -e '/^devtools\/deps$/d' .gitignore
  - cd ${TRAVIS_BUILD_DIR} && sed -i.sedbackup -e '/^\*\*\/dist$/d' .gitignore
  - cd ${TRAVIS_BUILD_DIR} && git log -n 1 > VERSION
  # remove an inaccurate README from arcs-live
  - cd ${TRAVIS_BUILD_DIR} && rm README.md
  # Temporarily push node_modules to arcs-live,
  # with the exception of exe files as Github complains about them.
  - cd ${TRAVIS_BUILD_DIR} && sed -i.sedbackup -e 's/^\*\*\/node_modules$/\*\*\/node_modules\/\*\*\/\*\.exe/' .gitignore
  # Configure for live.arcs.dev domain name and default web-shells redirect
  - cd ${TRAVIS_BUILD_DIR} && echo "live.arcs.dev" > CNAME
  - cd ${TRAVIS_BUILD_DIR} && echo '<head><meta http-equiv="refresh" content="0;/shells/web-shell/"></head>' > index.html


deploy:
  provider: pages

  skip-cleanup: true
  github-token: $GITHUB_TOKEN
  keep-history: true
  repo: PolymerLabs/arcs-live
  target_branch: master
  verbose: true
  on:
    branch: master
