<!DOCTYPE html>

<script src='../runtime/browser/build/planner.js'></script>
<link rel="import" href="se-explorer.html"></link>
<link rel="import" href="se-recipe-view.html"></link>

<style>
#toplevel {
  display: flex;
}
</style>

<div id='toplevel'>
  <se-explorer></se-explorer>
  <se-recipe-view></se-recipe-view>
</div>
<script>

var parentMap = new Map();
var lastID = 0;

function preparePopulation(population) {
  population = population.map(recipe => {
    let { result, score, parent, strategy } = recipe;
    return { result, score, parent, strategy, original: recipe };
  });
  population.forEach((item) => {
    item.id = lastID++;
    parentMap.set(item.original, item.id);
  });
  population.forEach(item => {
    if (item.parent)
      item.parent = parentMap.get(item.parent);
    item.original = undefined;
    item.result = item.result.toString();
    if (item.strategy)
      item.strategy = item.strategy.constructor.name;
  });
  var populationMap = {};
  population.forEach(item => {
    if (populationMap[item.strategy] == undefined)
      populationMap[item.strategy] = []
    populationMap[item.strategy].push(item);
  });
  var result = {population: []}
  Object.keys(populationMap).forEach(strategy => {
    result.population.push({strategy: strategy, recipes: populationMap[strategy]});
  })
  console.log(result)
  return result;
}

document.idMap = new Map();

(async () => {
  var loader = new Loader();
  systemParticles.register(loader);
  var a = new Arc({id: "test-plan-arc", loader});
  var p = new Planner();
  p.init(a);
  var result = [await p.generate(), await p.generate(), await p.generate()].map(preparePopulation);
  document.querySelector('se-explorer').results = result;
})();
</script>
